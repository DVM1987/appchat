name: Deploy Backend to VPS

on:
  push:
    branches: [main]
    paths:
      - 'backend/**'
  workflow_dispatch:  # Manual trigger

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to VPS via SSH
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.VPS_HOST }}
          username: root
          key: ${{ secrets.VPS_SSH_KEY }}
          envs: ESMS_API_KEY,ESMS_SECRET_KEY,ESMS_BRAND_NAME
          script: |
            cd /opt/appchat/backend
            
            # Pull latest code
            if [ -d ".git" ]; then
              git pull origin main
            else
              cd /opt/appchat
              rm -rf backend
              git clone --depth 1 --branch main ${{ secrets.REPO_URL }} /tmp/appchat-temp
              mv /tmp/appchat-temp/backend /opt/appchat/backend
              rm -rf /tmp/appchat-temp
            fi
            
            cd /opt/appchat/backend
            
            # Write .env file with secrets (never committed to git)
            cat > .env << EOF
            ESMS_API_KEY=${ESMS_API_KEY}
            ESMS_SECRET_KEY=${ESMS_SECRET_KEY}
            ESMS_BRAND_NAME=${ESMS_BRAND_NAME}
            EOF
            
            # Rebuild and restart services (DO NOT use 'down' - it destroys database volumes!)
            docker compose up -d --build --force-recreate
            
            # Cleanup unused images
            docker image prune -f
            
            # Health check
            sleep 10
            echo "=== Service Status ==="
            docker ps --format "table {{.Names}}\t{{.Status}}"
            echo "=== Deploy Complete ==="
        env:
          ESMS_API_KEY: ${{ secrets.ESMS_API_KEY }}
          ESMS_SECRET_KEY: ${{ secrets.ESMS_SECRET_KEY }}
          ESMS_BRAND_NAME: ${{ secrets.ESMS_BRAND_NAME }}

